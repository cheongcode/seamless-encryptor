<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seamless Encryptor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        accent: '#06b6d4',
                        dark: '#0f172a',
                        'dark-light': '#1e293b'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-dark via-slate-900 to-dark-light text-white min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gradient-to-br from-primary to-secondary flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center mb-6 mx-auto animate-pulse">
                <i class="fas fa-shield-alt text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Seamless Encryptor Pro</h2>
            <p class="text-white/80">Initializing secure environment...</p>
            <div class="w-48 h-1 bg-white/20 rounded-full mt-4 mx-auto overflow-hidden">
                <div class="h-full bg-white rounded-full animate-pulse"></div>
            </div>
            </div>
        </div>
        
    <!-- Main App -->
    <div id="app" class="hidden flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-dark-light border-r border-slate-700 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r from-primary to-accent rounded-lg flex items-center justify-center">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">Seamless Encryptor</h1>
                        <p class="text-xs text-slate-400">Enterprise Security</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="nav-item active flex items-center space-x-3 px-4 py-3 rounded-lg bg-primary text-white" data-section="dashboard">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white transition-all" data-section="encrypt">
                    <i class="fas fa-lock w-5"></i>
                    <span>Encrypt Files</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white transition-all" data-section="files">
                    <i class="fas fa-folder-open w-5"></i>
                    <span>Encrypted Files</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white transition-all" data-section="cloud">
                    <i class="fab fa-google-drive w-5"></i>
                    <span>Google Drive</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white transition-all" data-section="keys">
                    <i class="fas fa-key w-5"></i>
                    <span>Key Management</span>
                </a>
                <a href="#" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-slate-700 text-slate-300 hover:text-white transition-all" data-section="settings">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <!-- Key Status -->
            <div class="p-4 border-t border-slate-700">
                <div id="key-status" class="flex items-center space-x-3 p-3 bg-red-500/20 border border-red-500/30 rounded-lg">
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                    <div>
                        <p class="text-sm font-medium">No Encryption Key</p>
                        <p class="text-xs text-slate-400">Generate or import a key</p>
        </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-dark-light border-b border-slate-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="page-title" class="text-xl font-semibold">Dashboard</h2>
                        <p id="page-subtitle" class="text-sm text-slate-400">Overview of your encryption activities</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="cloud-status" class="hidden flex items-center space-x-2 px-3 py-1 bg-green-500/20 border border-green-500/30 rounded-full">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-xs">Google Drive Connected</span>
                        </div>
                        <button id="refresh-btn" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt"></i>
    </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-slate-400 text-sm">Total Files</p>
                                    <p id="total-files" class="text-2xl font-bold">0</p>
            </div>
                                <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file text-primary"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-slate-400 text-sm">Encrypted</p>
                                    <p id="encrypted-files" class="text-2xl font-bold text-green-400">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-shield-alt text-green-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-slate-400 text-sm">Cloud Synced</p>
                                    <p id="cloud-files" class="text-2xl font-bold text-blue-400">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fab fa-google-drive text-blue-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-slate-400 text-sm">Security Level</p>
                                    <p id="security-level" class="text-2xl font-bold text-yellow-400">Medium</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-yellow-400"></i>
                                </div>
                            </div>
            </div>
        </div>
        
                    <!-- Quick Actions -->
                    <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button class="quick-action-btn bg-gradient-to-r from-primary to-blue-600 hover:from-blue-600 hover:to-primary p-4 rounded-lg transition-all transform hover:scale-105" data-action="encrypt">
                                <i class="fas fa-lock text-2xl mb-2"></i>
                                <p class="font-medium">Encrypt Files</p>
                            </button>
                            <button class="quick-action-btn bg-gradient-to-r from-green-500 to-emerald-600 hover:from-emerald-600 hover:to-green-500 p-4 rounded-lg transition-all transform hover:scale-105" data-action="decrypt">
                                <i class="fas fa-unlock text-2xl mb-2"></i>
                                <p class="font-medium">Decrypt Files</p>
                            </button>
                            <button class="quick-action-btn bg-gradient-to-r from-purple-500 to-violet-600 hover:from-violet-600 hover:to-purple-500 p-4 rounded-lg transition-all transform hover:scale-105" data-action="generate-key">
                                <i class="fas fa-key text-2xl mb-2"></i>
                                <p class="font-medium">Generate Key</p>
                            </button>
                            <button class="quick-action-btn bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-blue-500 hover:to-cyan-500 p-4 rounded-lg transition-all transform hover:scale-105" data-action="connect-drive">
                                <i class="fab fa-google-drive text-2xl mb-2"></i>
                                <p class="font-medium">Connect Drive</p>
                </button>
                        </div>
                        
                        <!-- Debug Actions -->
                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <h4 class="text-sm font-medium text-slate-400 mb-2">Debug Actions</h4>
                            <div class="flex space-x-2">
                                <button onclick="testFileDialog()" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs transition-colors">
                                    Test File Dialog
                                </button>
                                <button onclick="testKeyStatus()" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs transition-colors">
                                    Test Key Status
                                </button>
                                <button onclick="testEncryptedFiles()" class="px-3 py-1 bg-slate-600 hover:bg-slate-500 rounded text-xs transition-colors">
                                    Test Load Files
                                </button>
                            </div>
                        </div>
            </div>
        </div>
        
                <!-- Encrypt Files Section -->
                <div id="encrypt-section" class="section hidden">
                    <div class="max-w-4xl mx-auto">
                        <!-- Encryption Method Selection -->
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">Encryption Settings</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Encryption Method</label>
                                    <select id="encryption-method" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="aes-256-gcm">AES-256-GCM (Recommended)</option>
                            <option value="chacha20-poly1305">ChaCha20-Poly1305</option>
                            <option value="xchacha20-poly1305">XChaCha20-Poly1305</option>
                        </select>
                    </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Auto Upload to Drive</label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-upload" class="sr-only">
                                        <div class="relative">
                                            <div class="w-11 h-6 bg-slate-600 rounded-full shadow-inner transition-colors duration-200"></div>
                                            <div class="absolute w-5 h-5 bg-white rounded-full shadow transform transition-transform duration-200 top-0.5 left-0.5"></div>
                                        </div>
                                        <span class="ml-3 text-sm">Enable auto-upload</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Drop Zone -->
                        <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-xl p-12 text-center hover:border-primary transition-all duration-300 cursor-pointer group">
                            <div class="max-w-md mx-auto">
                                <div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:bg-primary/20 transition-colors">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 group-hover:text-primary transition-colors"></i>
                                </div>
                                <h3 class="text-xl font-semibold mb-2 group-hover:text-white transition-colors">Drop files here to encrypt</h3>
                                <p class="text-slate-400 mb-6 group-hover:text-slate-300 transition-colors">Drag and drop your files or click the button below</p>
                                <button id="browse-btn" class="bg-primary hover:bg-blue-600 px-8 py-3 rounded-lg transition-all duration-200 font-medium transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-dark">
                                    <i class="fas fa-folder-open mr-2"></i>
                                    Browse Files
                    </button>
                </div>
            </div>
            
                        <!-- File Queue -->
                        <div id="file-queue" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-4">Files to Encrypt</h3>
                            <div id="file-list" class="space-y-3"></div>
                            <div class="flex justify-end mt-4 space-x-3">
                                <button id="clear-queue" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">Clear All</button>
                                <button id="encrypt-all" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg transition-colors">
                                    <i class="fas fa-lock mr-2"></i>
                                    Encrypt All Files
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Encrypted Files Section -->
                <div id="files-section" class="section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold">Encrypted Files</h3>
                        <button id="refresh-files" class="px-4 py-2 bg-primary hover:bg-blue-600 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                    <div id="encrypted-files-list" class="space-y-3">
                        <div class="text-center py-12 text-slate-400">
                            <i class="fas fa-folder-open text-4xl mb-4"></i>
                            <p>No encrypted files found</p>
                        </div>
                    </div>
                </div>

                <!-- Google Drive Section -->
                <div id="cloud-section" class="section hidden">
                    <div class="max-w-4xl mx-auto">
                        <!-- Connection Status -->
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold mb-2">Google Drive Integration</h3>
                                    <p id="drive-status-text" class="text-slate-400">Connect your Google Drive to automatically backup encrypted files</p>
                                </div>
                                <button id="connect-drive-btn" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
                                    <i class="fab fa-google-drive mr-2"></i>
                                    Connect Drive
                                </button>
                            </div>
                        </div>

                        <!-- Drive Files -->
                        <div id="drive-files-container" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">Files in Google Drive</h3>
                                <button id="refresh-drive" class="px-4 py-2 bg-primary hover:bg-blue-600 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Refresh
                                </button>
                            </div>
                            <div id="drive-files-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Key Management Section -->
                <div id="keys-section" class="section hidden">
                    <div class="max-w-4xl mx-auto space-y-6">
                        <!-- Current Status Banner -->
                        <div id="current-key-status" class="p-4 bg-green-500/10 border border-green-500/20 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <div>
                                    <p class="font-medium text-green-400">Encryption key is active</p>
                                    <p class="text-sm text-slate-400">Your files can be encrypted securely</p>
                                </div>
                            </div>
                        </div>

                        <!-- Available Keys List -->
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold">Available Encryption Keys</h3>
                                <button id="refresh-keys-btn" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors text-sm">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Refresh List
                                </button>
                            </div>
                            
                            <!-- No Keys Warning -->
                            <div id="no-keys-warning" class="hidden p-4 bg-orange-500/10 border border-orange-500/20 rounded-lg mb-6">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-exclamation-triangle text-orange-400"></i>
                                    <div>
                                        <p class="font-medium text-orange-400">No Encryption Keys Found</p>
                                        <p class="text-sm text-slate-400">You need to generate or import a key before you can encrypt or decrypt files. Use the buttons below to create your first key.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Keys List Container -->
                            <div id="keys-list" class="space-y-3 mb-6">
                                <!-- Keys will be dynamically populated here -->
                            </div>

                            <!-- Key Management Actions -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button id="generate-key-btn" class="p-4 bg-green-500 hover:bg-green-600 rounded-lg transition-colors text-center">
                                    <i class="fas fa-plus-circle text-2xl mb-2"></i>
                                    <p class="font-medium">Generate New Key</p>
                                    <p class="text-sm opacity-80">Create a secure encryption key</p>
                                </button>
                                <button id="create-custom-key-btn" class="p-4 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors text-center">
                                    <i class="fas fa-key text-2xl mb-2"></i>
                                    <p class="font-medium">Create Custom Key</p>
                                    <p class="text-sm opacity-80">Use your own passphrase</p>
                                </button>
                                <button id="import-key-btn" class="p-4 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors text-center">
                                    <i class="fas fa-file-import text-2xl mb-2"></i>
                                    <p class="font-medium">Import Key</p>
                                    <p class="text-sm opacity-80">Load an existing key file</p>
                                </button>
                            </div>
                        </div>

                        <!-- Create Custom Key Panel -->
                        <div id="custom-key-panel" class="hidden bg-dark-light border border-slate-700 rounded-xl p-6">
                            <h4 class="text-lg font-semibold mb-4">Create Custom Key</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Custom Key Phrase</label>
                                    <input type="password" id="custom-key-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter a strong, memorable phrase">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Entropy Strength</label>
                                    <div class="w-full bg-slate-700 rounded-full h-2 mb-2">
                                        <div id="entropy-fill" class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                    <p id="entropy-status" class="text-sm text-slate-400">Enter a phrase to check strength</p>
                                </div>
                                <div class="flex space-x-3">
                                    <button id="create-custom-key-confirm" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg transition-colors disabled:opacity-50" disabled>
                                        <i class="fas fa-key mr-2"></i>
                                        Create Key
                                    </button>
                                    <button id="cancel-custom-key" class="px-6 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="section hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="bg-dark-light border border-slate-700 rounded-xl p-6">
                            <h3 class="text-lg font-semibold mb-6">Application Settings</h3>
                            
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Output Directory</label>
                                    <div class="flex space-x-2">
                                        <input id="output-dir" type="text" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" readonly>
                                        <button id="select-output-dir" class="px-4 py-2 bg-primary hover:bg-blue-600 rounded-lg transition-colors">Browse</button>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="auto-delete" class="sr-only">
                                        <div class="relative">
                                            <div class="w-11 h-6 bg-slate-600 rounded-full shadow-inner transition-colors duration-200"></div>
                                            <div class="absolute w-5 h-5 bg-white rounded-full shadow transform transition-transform duration-200 top-0.5 left-0.5"></div>
                                        </div>
                                        <span class="ml-3">Auto-delete original files after encryption</span>
                                    </label>

                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="notifications" class="sr-only">
                                        <div class="relative">
                                            <div class="w-11 h-6 bg-slate-600 rounded-full shadow-inner transition-colors duration-200"></div>
                                            <div class="absolute w-5 h-5 bg-white rounded-full shadow transform transition-transform duration-200 top-0.5 left-0.5"></div>
                                        </div>
                                        <span class="ml-3">Show notifications</span>
                                    </label>

                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="confirm-actions" class="sr-only">
                                        <div class="relative">
                                            <div class="w-11 h-6 bg-slate-600 rounded-full shadow-inner transition-colors duration-200"></div>
                                            <div class="absolute w-5 h-5 bg-white rounded-full shadow transform transition-transform duration-200 top-0.5 left-0.5"></div>
                                        </div>
                                        <span class="ml-3">Confirm destructive actions</span>
                                    </label>
                                </div>

                                <div class="pt-4 border-t border-slate-700">
                                    <button id="reset-settings" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors">
                                        Reset to Defaults
                                    </button>
                                </div>
                            </div>
                </div>
            </div>
        </div>
    </main>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Progress Modal -->
    <div id="progress-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-dark-light border border-slate-700 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i id="progress-icon" class="fas fa-lock text-2xl text-primary"></i>
                </div>
                <h3 id="progress-title" class="text-lg font-semibold mb-2">Processing...</h3>
                <p id="progress-text" class="text-slate-400 mb-4">Please wait while we process your files</p>
                <div class="w-full bg-slate-700 rounded-full h-2 mb-4">
                    <div id="progress-bar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-percentage" class="text-sm text-slate-400">0%</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentSection = 'dashboard';
        let fileQueue = [];
        let encryptedFiles = [];
        let driveFiles = [];
        let isKeyGenerated = false;
        let isDriveConnected = false;
        let currentStats = {
            totalFiles: 0,
            encryptedFiles: 0,
            cloudFiles: 0,
            securityLevel: 'Low'
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing app...');
            
            // Simulate loading
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initializeApp();
            }, 2000);
        });

        async function initializeApp() {
            console.log('Initializing Seamless Encryptor Pro...');
            
            // Setup event listeners
            setupEventListeners();
            
            // Check initial states
            await loadKeysList(); // This will also update key status
            await checkDriveStatus();
            await loadEncryptedFiles();
            await loadSettings();
            
            // Update dashboard
            updateDashboard();
            
            // Debug: Check API availability
            console.log('Available APIs:', {
                api: !!window.api,
                cloudApi: !!window.cloudApi,
                settingsApi: !!window.settingsApi,
                encryptFile: !!window.api?.encryptFile,
                openFileDialog: !!window.api?.openFileDialog,
                getEncryptedFiles: !!window.api?.getEncryptedFiles,
                checkKeyStatus: !!window.api?.checkKeyStatus,
                generateKey: !!window.api?.generateKey,
                createCustomKey: !!window.api?.createCustomKey,
                exportKey: !!window.api?.exportKey,
                deleteKey: !!window.api?.deleteKey
            });
            
            showToast('Application initialized successfully!', 'success');
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    switchSection(section);
                });
            });

            // Quick actions
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = btn.dataset.action;
                    handleQuickAction(action);
                });
            });

            // File operations
            setupFileOperations();
            
            // Key management
            setupKeyManagement();
            
            // Setup key event delegation for export/delete buttons
            setupKeyEventDelegation();
            
            // Google Drive
            setupGoogleDrive();
            
            // Settings
            setupSettings();
            
            // Drag and drop
            setupDragAndDrop();
        }

        function setupFileOperations() {
            const dropZone = document.getElementById('drop-zone');
            const browseBtn = document.getElementById('browse-btn');
            const encryptAllBtn = document.getElementById('encrypt-all');
            const clearQueueBtn = document.getElementById('clear-queue');
            const refreshFilesBtn = document.getElementById('refresh-files');

            browseBtn?.addEventListener('click', openFileDialog);
            encryptAllBtn?.addEventListener('click', encryptAllFiles);
            clearQueueBtn?.addEventListener('click', clearFileQueue);
            refreshFilesBtn?.addEventListener('click', loadEncryptedFiles);

            // Encryption method change
            const encryptionMethod = document.getElementById('encryption-method');
            encryptionMethod?.addEventListener('change', async (e) => {
                if (window.api?.setEncryptionMethod) {
                    await window.api.setEncryptionMethod(e.target.value);
                    showToast(`Encryption method changed to ${e.target.value}`, 'info');
                }
            });
        }

        function setupKeyManagement() {
            const generateKeyBtn = document.getElementById('generate-key-btn');
            const createCustomKeyBtn = document.getElementById('create-custom-key-btn');
            const importKeyBtn = document.getElementById('import-key-btn');
            const refreshKeysBtn = document.getElementById('refresh-keys-btn');
            const createCustomKeyConfirmBtn = document.getElementById('create-custom-key-confirm');
            const cancelCustomKeyBtn = document.getElementById('cancel-custom-key');

            generateKeyBtn?.addEventListener('click', generateNewKey);
            createCustomKeyBtn?.addEventListener('click', createCustomKey);
            importKeyBtn?.addEventListener('click', importKey);
            refreshKeysBtn?.addEventListener('click', refreshKeysList);
            createCustomKeyConfirmBtn?.addEventListener('click', createCustomKeyConfirm);
            cancelCustomKeyBtn?.addEventListener('click', cancelCustomKey);

            // Setup entropy meter for custom key input
            setupCustomKeyEntropy();

            // Load keys list when key management section is initialized
            if (currentSection === 'keys') {
                loadKeysList();
            }
        }

        function setupGoogleDrive() {
            const connectDriveBtn = document.getElementById('connect-drive-btn');
            const refreshDriveBtn = document.getElementById('refresh-drive');

            connectDriveBtn?.addEventListener('click', connectGoogleDrive);
            refreshDriveBtn?.addEventListener('click', loadDriveFiles);
        }

        function setupSettings() {
            const selectOutputDirBtn = document.getElementById('select-output-dir');
            const resetSettingsBtn = document.getElementById('reset-settings');

            selectOutputDirBtn?.addEventListener('click', selectOutputDirectory);
            resetSettingsBtn?.addEventListener('click', resetSettings);

            // Toggle switches
            setupToggleSwitches();
        }

        function setupToggleSwitches() {
            const toggles = ['auto-upload', 'auto-delete', 'notifications', 'confirm-actions'];
            
            toggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', (e) => {
                        const toggleContainer = e.target.parentElement.querySelector('div > div:first-child');
                        const toggleButton = e.target.parentElement.querySelector('div > div:last-child');
                        
                        if (e.target.checked) {
                            toggleContainer.classList.add('bg-primary');
                            toggleContainer.classList.remove('bg-slate-600');
                            toggleButton.style.transform = 'translateX(20px)';
                    } else {
                            toggleContainer.classList.remove('bg-primary');
                            toggleContainer.classList.add('bg-slate-600');
                            toggleButton.style.transform = 'translateX(0)';
                    }
                        
                        saveSettings();
                });
            }
        });
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-primary', 'bg-primary/10');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary', 'bg-primary/10');
                });

                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary', 'bg-primary/10');
                    
                    const droppedFiles = Array.from(e.dataTransfer.files);
                    console.log('Files dropped:', droppedFiles);
                    
                    if (droppedFiles.length > 0) {
                        // Convert File objects to our format
                        const files = await Promise.all(droppedFiles.map(async (file) => {
                            // In Electron, file.path is available for files from the filesystem
                            const filePath = file.path || file.name;
                            
                            // Try to get file stats if it's a filesystem path
                            let fileSize = file.size;
                            if (file.path && window.api?.getFileStats) {
                                try {
                                    const stats = await window.api.getFileStats(file.path);
                                    if (stats?.size) {
                                        fileSize = stats.size;
                                    }
                                } catch (error) {
                                    console.warn('Could not get file stats:', error);
                                }
                            }
                            
                            return {
                                path: filePath,
                                name: file.name,
                                size: fileSize
                            };
                        }));
                        
                        console.log('Processed dropped files:', files);
                        addFilesToQueue(files);
                    }
                });

                dropZone.addEventListener('click', openFileDialog);
            }
        }

        function switchSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-primary', 'text-white');
                item.classList.add('text-slate-300', 'hover:text-white');
            });
            
            const activeNav = document.querySelector(`[data-section="${section}"]`);
            if (activeNav) {
                activeNav.classList.add('active', 'bg-primary', 'text-white');
                activeNav.classList.remove('text-slate-300', 'hover:text-white');
            }

            // Update sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            const activeSection = document.getElementById(`${section}-section`);
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }

            // Update header
            updateHeader(section);
            currentSection = section;

            // Load section-specific data
            if (section === 'keys') {
                loadKeysList();
            } else if (section === 'files') {
                loadEncryptedFiles();
            } else if (section === 'cloud') {
                loadDriveFiles();
            }
        }

        function updateHeader(section) {
            const titles = {
                dashboard: { title: 'Dashboard', subtitle: 'Overview of your encryption activities' },
                encrypt: { title: 'Encrypt Files', subtitle: 'Secure your files with military-grade encryption' },
                files: { title: 'Encrypted Files', subtitle: 'Manage your encrypted file collection' },
                cloud: { title: 'Google Drive', subtitle: 'Cloud storage integration and sync' },
                keys: { title: 'Key Management', subtitle: 'Manage your encryption keys securely' },
                settings: { title: 'Settings', subtitle: 'Configure application preferences' }
            };

            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            
            if (pageTitle && pageSubtitle && titles[section]) {
                pageTitle.textContent = titles[section].title;
                pageSubtitle.textContent = titles[section].subtitle;
            }
        }

        function handleQuickAction(action) {
            switch (action) {
                case 'encrypt':
                    switchSection('encrypt');
                    break;
                case 'decrypt':
                    switchSection('files');
                    break;
                case 'generate-key':
                    generateEncryptionKey();
                    break;
                case 'connect-drive':
                    connectGoogleDrive();
                    break;
            }
        }

        async function openFileDialog() {
            // Prevent multiple dialogs from opening simultaneously
            if (window.fileDialogOpen) {
                console.log('[RENDERER] File dialog already open, ignoring additional requests');
                return;
            }
            
            try {
                window.fileDialogOpen = true;
                
                if (window.api?.openFileDialog) {
                    console.log('[RENDERER] Calling openFileDialog...');
                    const result = await window.api.openFileDialog();
                    console.log('[RENDERER] File dialog result:', result);
                    
                    if (result && Array.isArray(result) && result.length > 0) {
                        console.log('[RENDERER] Processing', result.length, 'selected files');
                        
                        let files;
                        
                        // Check if result contains file objects or just paths
                        if (typeof result[0] === 'string') {
                            console.log('[RENDERER] Converting path strings to file objects');
                            // Convert path strings to file objects
                            files = result.map(filePath => ({
                                path: filePath,
                                name: filePath.split('/').pop() || filePath.split('\\').pop() || 'Unknown File',
                                size: 0 // Will be determined during encryption
                            }));
                        } else {
                            console.log('[RENDERER] Using file objects as-is');
                            // Already file objects
                            files = result;
                        }
                        
                        console.log('[RENDERER] Processed files for queue:', files);
                        addFilesToQueue(files);
                    } else {
                        console.log('[RENDERER] No files selected or dialog was cancelled');
                    }
                }
            } catch (error) {
                console.error('[RENDERER] Error opening file dialog:', error);
                showToast('Failed to open file dialog', 'error');
            } finally {
                // Always clear the flag, even if there was an error
                setTimeout(() => {
                    window.fileDialogOpen = false;
                }, 500); // Small delay to prevent rapid successive calls
            }
        }

        function addFilesToQueue(files) {
            console.log('Adding files to queue:', files);
            
            if (!files || files.length === 0) {
                showToast('No files to add to queue', 'warning');
                return;
            }
            
            let addedCount = 0;
            
            files.forEach(file => {
                // Ensure file has required properties
                if (!file || (!file.path && !file.name)) {
                    console.warn('Invalid file object:', file);
                    return;
                }
                
                // Normalize file object
                const normalizedFile = {
                    path: file.path || file.name,
                    name: file.name || (file.path ? (file.path.split('/').pop() || file.path.split('\\').pop()) : 'Unknown File'),
                    size: file.size || 0
                };
                
                // Check if file already exists in queue
                const existingFile = fileQueue.find(f => 
                    f.path === normalizedFile.path || 
                    (f.name === normalizedFile.name && f.path === normalizedFile.path)
                );
                
                if (!existingFile) {
                    const queueFile = {
                        id: Date.now() + Math.random(),
                        name: normalizedFile.name,
                        path: normalizedFile.path,
                        size: normalizedFile.size,
                        status: 'pending'
                    };
                    
                    fileQueue.push(queueFile);
                    addedCount++;
                    console.log('Added file to queue:', queueFile);
                } else {
                    console.log('File already in queue:', normalizedFile.name);
                }
            });
            
            updateFileQueue();
            
            if (addedCount > 0) {
                showToast(`Added ${addedCount} file(s) to encryption queue`, 'success');
                
                // Switch to encrypt section if not already there
                if (currentSection !== 'encrypt') {
                    switchSection('encrypt');
                }
            } else {
                showToast('All selected files are already in the queue', 'info');
            }
        }

        function updateFileQueue() {
            const fileQueueContainer = document.getElementById('file-queue');
            const fileListContainer = document.getElementById('file-list');
            
            if (fileQueue.length === 0) {
                fileQueueContainer?.classList.add('hidden');
                return;
            }
            
            fileQueueContainer?.classList.remove('hidden');
            
            if (fileListContainer) {
                fileListContainer.innerHTML = fileQueue.map(file => {
                    const statusColor = file.status === 'encrypted' ? 'text-green-400' : 
                                      file.status === 'failed' ? 'text-red-400' : 
                                      file.status === 'encrypting' ? 'text-yellow-400' : 'text-slate-400';
                    
                    const statusIcon = file.status === 'encrypted' ? 'fas fa-check-circle' : 
                                     file.status === 'failed' ? 'fas fa-exclamation-circle' : 
                                     file.status === 'encrypting' ? 'fas fa-spinner fa-spin' : 'fas fa-clock';
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-dark-light border border-slate-700 rounded-lg hover:border-slate-600 transition-colors">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-primary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file text-primary"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium">${file.name}</p>
                                    <div class="flex items-center space-x-2 text-sm">
                                        <span class="text-slate-400">${formatFileSize(file.size)}</span>
                                        <span class="text-slate-600">•</span>
                                        <i class="${statusIcon} ${statusColor}"></i>
                                        <span class="${statusColor} capitalize">${file.status}</span>
                                        ${file.analysis ? `
                                            <span class="text-slate-600">•</span>
                                            <span class="text-purple-400">Analyzed</span>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${file.status === 'encrypted' && file.analysis ? `
                                    <button onclick="showAnalysisModal(${JSON.stringify(file.analysis).replace(/"/g, '&quot;')})" class="p-2 text-purple-400 hover:bg-purple-500/20 rounded-lg transition-colors" title="View Analysis">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                ` : ''}
                                <button onclick="removeFromQueue('${file.id}')" class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function removeFromQueue(fileId) {
            fileQueue = fileQueue.filter(f => f.id !== fileId);
            updateFileQueue();
        }

        function clearFileQueue() {
            fileQueue = [];
            updateFileQueue();
            showToast('File queue cleared', 'info');
        }

        async function encryptAllFiles() {
            if (fileQueue.length === 0) {
                showToast('No files in queue to encrypt', 'warning');
                return;
            }

            if (!isKeyGenerated) {
                showToast('Please generate or import an encryption key first', 'error');
                switchSection('keys');
                return;
            }

            showProgressModal('Encrypting Files', 'Processing your files with secure encryption...');
            
            let successCount = 0;
            let totalFiles = fileQueue.length;
            
            try {
                for (let i = 0; i < fileQueue.length; i++) {
                    const file = fileQueue[i];
                    file.status = 'encrypting';
                    updateFileQueue();
                    updateProgress((i / totalFiles) * 100, `Encrypting ${file.name}...`);
                    
                    try {
                        if (window.api?.encryptFile) {
                            // Get selected encryption method
                            const encryptionMethod = document.getElementById('encryption-method')?.value || 'aes-256-gcm';
                            
                            console.log(`Encrypting file: ${file.path} with method: ${encryptionMethod}`);
                            const result = await window.api.encryptFile(file.path, encryptionMethod);
                            console.log(`Encryption result for ${file.name}:`, result);
                            
                            if (result?.success) {
                                successCount++;
                                file.status = 'encrypted';
                                
                                // Perform code analysis on the encrypted file
                                if (result.fileId) {
                                    try {
                                        const analysisResult = await window.api.analyzeFileEntropy(result.fileId);
                                        if (analysisResult?.success) {
                                            console.log(`File analysis for ${file.name}:`, analysisResult);
                                            file.analysis = analysisResult;
                                        }
                                    } catch (analysisError) {
                                        console.warn('File analysis failed:', analysisError);
                                    }
                                }
                                
                                // Auto-upload to Drive if enabled
                                const autoUpload = document.getElementById('auto-upload')?.checked;
                                if (autoUpload && isDriveConnected && result.encryptedPath) {
                                    try {
                                        await uploadToDrive(result.encryptedPath, file.name + '.enc');
                                    } catch (uploadError) {
                                        console.warn('Auto-upload failed:', uploadError);
                                    }
                                }
                            } else {
                                file.status = 'failed';
                                console.error('Encryption failed:', result?.error);
                            }
                        } else {
                            file.status = 'failed';
                            console.error('API not available');
                        }
                    } catch (error) {
                        console.error('Encryption error:', error);
                        file.status = 'failed';
                    }
                    
                    // Update file queue display
                    updateFileQueue();
                }
                
                updateProgress(100, 'Encryption complete!');
                
                setTimeout(() => {
                    hideProgressModal();
                    loadEncryptedFiles();
                    updateDashboard();
                    
                    if (successCount === totalFiles) {
                        showToast(`Successfully encrypted ${successCount} file(s)!`, 'success');
                        clearFileQueue();
                    } else {
                        showToast(`Encrypted ${successCount}/${totalFiles} files. ${totalFiles - successCount} failed.`, 'warning');
                    }
                }, 1000);
            } catch (error) {
                hideProgressModal();
                console.error('Encryption process error:', error);
                showToast('Encryption process failed', 'error');
            }
        }

        async function checkKeyStatus() {
            try {
                if (window.api?.checkKeyStatus) {
                    const status = await window.api.checkKeyStatus();
                    isKeyGenerated = status?.hasKey || false;
                    updateKeyStatus(isKeyGenerated);
                }
            } catch (error) {
                console.error('Error checking key status:', error);
                updateKeyStatus(false);
            }
        }

        function updateKeyStatus(hasKey) {
            const keyStatus = document.getElementById('key-status');
            const currentKeyStatus = document.getElementById('current-key-status');
            const exportKeyBtn = document.getElementById('export-key-btn');
            
            if (hasKey) {
                // Sidebar status
                if (keyStatus) {
                    keyStatus.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <div>
                            <p class="text-sm font-medium">Encryption Key Active</p>
                            <p class="text-xs text-slate-400">Ready to encrypt files</p>
                        </div>
                    `;
                    keyStatus.className = 'flex items-center space-x-3 p-3 bg-green-500/20 border border-green-500/30 rounded-lg';
                }
                
                // Key management page status
                if (currentKeyStatus) {
                    currentKeyStatus.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-check-circle text-green-400"></i>
                            <div>
                                <p class="font-medium text-green-400">Encryption key is active</p>
                                <p class="text-sm text-slate-400">Your files can be encrypted securely</p>
                            </div>
                        </div>
                    `;
                    currentKeyStatus.className = 'p-4 bg-green-500/10 border border-green-500/20 rounded-lg';
                }
                
                exportKeyBtn?.classList.remove('hidden');
                currentStats.securityLevel = 'High';
            } else {
                // Sidebar status
                if (keyStatus) {
                    keyStatus.innerHTML = `
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <div>
                            <p class="text-sm font-medium">No Encryption Key</p>
                            <p class="text-xs text-slate-400">Generate or import a key</p>
                        </div>
                    `;
                    keyStatus.className = 'flex items-center space-x-3 p-3 bg-red-500/20 border border-red-500/30 rounded-lg';
                }
                
                exportKeyBtn?.classList.add('hidden');
                currentStats.securityLevel = 'Low';
            }
            
            isKeyGenerated = hasKey;
            updateDashboard();
        }

        async function generateEncryptionKey() {
            try {
                showProgressModal('Generating Key', 'Creating a secure encryption key...');
                updateProgress(30, 'Generating random entropy...');
                
                if (window.api?.generateKey) {
                    const result = await window.api.generateKey();
                    updateProgress(100, 'Key generated successfully!');
                    
                    setTimeout(() => {
                        hideProgressModal();
                        if (result?.success) {
                            showToast('Encryption key generated successfully!', 'success');
                            updateKeyStatus(true);
                        } else {
                            showToast('Failed to generate encryption key', 'error');
                        }
                    }, 1000);
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error generating key:', error);
                showToast('Failed to generate encryption key', 'error');
            }
        }

        function createCustomKey() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-light border border-slate-700 rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-key text-4xl text-orange-400 mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Create Custom Key</h3>
                        <p class="text-slate-400">Enter a strong passphrase to create your encryption key</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Passphrase:</label>
                            <input type="password" id="custom-passphrase" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg focus:border-primary focus:outline-none" placeholder="Enter a strong passphrase...">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Confirm Passphrase:</label>
                            <input type="password" id="confirm-passphrase" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg focus:border-primary focus:outline-none" placeholder="Confirm your passphrase...">
                        </div>
                        
                        <div class="text-xs text-slate-400 bg-slate-800 p-3 rounded-lg">
                            <p class="font-medium mb-1">Security Tips:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Use at least 12 characters</li>
                                <li>Include uppercase, lowercase, numbers, and symbols</li>
                                <li>Avoid common words or personal information</li>
                                <li>Store your passphrase securely</li>
                            </ul>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="submitCustomKey()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                Create Key
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus the first input
            setTimeout(() => {
                const input = document.getElementById('custom-passphrase');
                if (input) input.focus();
            }, 100);
        }

        async function submitCustomKey() {
            const passphrase = document.getElementById('custom-passphrase')?.value;
            const confirmPassphrase = document.getElementById('confirm-passphrase')?.value;
            
            if (!passphrase || !confirmPassphrase) {
                showToast('Please fill in both passphrase fields', 'warning');
                return;
            }
            
            if (passphrase !== confirmPassphrase) {
                showToast('Passphrases do not match', 'error');
                return;
            }
            
            if (passphrase.length < 8) {
                showToast('Passphrase must be at least 8 characters long', 'warning');
                return;
            }
            
            try {
                showProgressModal('Creating Key', 'Generating key from your passphrase...');
                
                if (window.api?.createCustomKey) {
                    const result = await window.api.createCustomKey(passphrase);
                    hideProgressModal();
                    
                    // Close the modal
                    const modal = document.querySelector('.fixed');
                    if (modal) modal.remove();
                    
                    if (result?.success) {
                        showToast('Custom encryption key created successfully!', 'success');
                        updateKeyStatus(true);
                        currentStats.securityLevel = 'High';
                        updateDashboard();
                    } else {
                        showToast(`Failed to create custom key: ${result?.error || 'Unknown error'}`, 'error');
                    }
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error creating custom key:', error);
                showToast('Failed to create custom key', 'error');
            }
        }

        async function importEncryptionKey() {
            try {
                if (window.api?.openFileDialog) {
                    const result = await window.api.openFileDialog();
                    if (result && !result.canceled && result.filePaths?.length > 0) {
                        const keyPath = result.filePaths[0];
                        
                        if (window.api?.importKey) {
                            const importResult = await window.api.importKey(keyPath);
                            if (importResult?.success) {
                                showToast('Encryption key imported successfully!', 'success');
                                updateKeyStatus(true);
                            } else {
                                showToast('Failed to import encryption key', 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error importing key:', error);
                showToast('Failed to import encryption key', 'error');
            }
        }

        async function exportEncryptionKey() {
            try {
                if (window.api?.exportKey) {
                    const result = await window.api.exportKey();
                    if (result?.success) {
                        showToast('Encryption key exported successfully!', 'success');
                    } else {
                        showToast('Failed to export encryption key', 'error');
                    }
                }
            } catch (error) {
                console.error('Error exporting key:', error);
                showToast('Failed to export encryption key', 'error');
            }
        }

        async function checkDriveStatus() {
            try {
                if (window.cloudApi?.getGDriveStatus) {
                    const status = await window.cloudApi.getGDriveStatus();
                    isDriveConnected = status?.connected || false;
                    updateDriveStatus(isDriveConnected, status?.userEmail);
                }
            } catch (error) {
                console.error('Error checking Drive status:', error);
                updateDriveStatus(false);
            }
        }

        function updateDriveStatus(connected, userEmail = null) {
            const cloudStatus = document.getElementById('cloud-status');
            const connectDriveBtn = document.getElementById('connect-drive-btn');
            const driveStatusText = document.getElementById('drive-status-text');
            const driveFilesContainer = document.getElementById('drive-files-container');
            
            if (connected) {
                cloudStatus?.classList.remove('hidden');
                if (connectDriveBtn) {
                    connectDriveBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Disconnect';
                    connectDriveBtn.onclick = disconnectGoogleDrive;
                }
                if (driveStatusText) {
                    driveStatusText.textContent = `Connected as ${userEmail || 'Unknown User'}`;
                }
                driveFilesContainer?.classList.remove('hidden');
                loadDriveFiles();
            } else {
                cloudStatus?.classList.add('hidden');
                if (connectDriveBtn) {
                    connectDriveBtn.innerHTML = '<i class="fab fa-google-drive mr-2"></i>Connect Drive';
                    connectDriveBtn.onclick = connectGoogleDrive;
                }
                if (driveStatusText) {
                    driveStatusText.textContent = 'Connect your Google Drive to automatically backup encrypted files';
                }
                driveFilesContainer?.classList.add('hidden');
            }
            
            isDriveConnected = connected;
            updateDashboard();
        }

        async function connectGoogleDrive() {
            try {
                showProgressModal('Connecting to Google Drive', 'Getting authorization URL...');
                
                if (window.cloudApi?.connectGDrive) {
                    const result = await window.cloudApi.connectGDrive();
                    hideProgressModal();
                    
                    if (result?.success && result.authUrl) {
                        // Open the auth URL in the user's browser
                        if (window.api?.openExternalUrl) {
                            await window.api.openExternalUrl(result.authUrl);
                        }
                        
                        // Show instructions to user
                        showAuthCodeModal();
                    } else {
                        showToast('Failed to get Google Drive authorization URL', 'error');
                    }
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error connecting to Drive:', error);
                showToast('Failed to connect to Google Drive', 'error');
            }
        }

        function showAuthCodeModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-light border border-slate-700 rounded-xl p-6 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fab fa-google-drive text-4xl text-blue-400 mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Google Drive Authorization</h3>
                        <p class="text-slate-400">Complete the authorization in your browser, then paste the code below:</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Authorization Code:</label>
                            <input type="text" id="auth-code-input" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg focus:border-primary focus:outline-none" placeholder="Paste authorization code here...">
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="submitAuthCode()" class="flex-1 bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg transition-colors">
                                Connect
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById('auth-code-input');
                if (input) input.focus();
            }, 100);
        }

        async function submitAuthCode() {
            const input = document.getElementById('auth-code-input');
            const authCode = input?.value?.trim();
            
            if (!authCode) {
                showToast('Please enter the authorization code', 'warning');
                return;
            }
            
            try {
                showProgressModal('Connecting to Google Drive', 'Exchanging authorization code...');
                
                if (window.cloudApi?.exchangeGDriveAuthCode) {
                    const result = await window.cloudApi.exchangeGDriveAuthCode(authCode);
                    hideProgressModal();
                    
                    // Close the auth modal
                    const modal = document.querySelector('.fixed');
                    if (modal) modal.remove();
                    
                    if (result?.success) {
                        showToast('Successfully connected to Google Drive!', 'success');
                        updateDriveStatus(true, result.email);
                        checkDriveStatus(); // Refresh status
                    } else {
                        showToast(`Failed to connect: ${result?.error || 'Unknown error'}`, 'error');
                    }
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error exchanging auth code:', error);
                showToast('Failed to connect to Google Drive', 'error');
            }
        }

        async function disconnectGoogleDrive() {
            try {
                if (window.cloudApi?.disconnectGDrive) {
                    const result = await window.cloudApi.disconnectGDrive();
                    if (result?.success) {
                        showToast('Disconnected from Google Drive', 'info');
                        updateDriveStatus(false);
                    }
                }
            } catch (error) {
                console.error('Error disconnecting from Drive:', error);
                showToast('Failed to disconnect from Google Drive', 'error');
            }
        }

        async function loadDriveFiles() {
            if (!isDriveConnected) return;
            
            try {
                if (window.cloudApi?.listGDriveFiles) {
                    const result = await window.cloudApi.listGDriveFiles();
                    if (result?.success && result.files) {
                        driveFiles = result.files;
                        updateDriveFilesList();
                        currentStats.cloudFiles = driveFiles.length;
                        updateDashboard();
                    }
                }
            } catch (error) {
                console.error('Error loading Drive files:', error);
            }
        }

        function updateDriveFilesList() {
            const driveFilesList = document.getElementById('drive-files-list');
            if (!driveFilesList) return;
            
            if (driveFiles.length === 0) {
                driveFilesList.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i class="fab fa-google-drive text-4xl mb-4"></i>
                        <p>No files found in Google Drive</p>
                    </div>
                `;
                return;
            }
            
            driveFilesList.innerHTML = driveFiles.map(file => `
                <div class="flex items-center justify-between p-4 bg-dark-light border border-slate-700 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                            <i class="fab fa-google-drive text-blue-400"></i>
                        </div>
                        <div>
                            <p class="font-medium">${file.name}</p>
                            <p class="text-sm text-slate-400">${formatFileSize(file.size)} • ${formatDate(file.modifiedTime)}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="downloadFromDrive('${file.id}', '${file.name}')" class="p-2 text-green-400 hover:bg-green-500/20 rounded-lg transition-colors">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function uploadToDrive(filePath, fileName) {
            try {
                if (window.cloudApi?.uploadFileToGDrive) {
                    const result = await window.cloudApi.uploadFileToGDrive(filePath, fileName);
                    if (result?.success) {
                        showToast(`Uploaded ${fileName} to Google Drive`, 'success');
                        loadDriveFiles();
                    }
                }
            } catch (error) {
                console.error('Error uploading to Drive:', error);
            }
        }

        async function downloadFromDrive(fileId, fileName) {
            try {
                showProgressModal('Downloading', `Downloading ${fileName} from Google Drive...`);
                
                // Implementation would depend on your Drive API setup
                showToast(`Downloaded ${fileName} from Google Drive`, 'success');
                hideProgressModal();
            } catch (error) {
                hideProgressModal();
                console.error('Error downloading from Drive:', error);
                showToast('Failed to download file from Google Drive', 'error');
            }
        }

        async function loadEncryptedFiles() {
            try {
                console.log('Loading encrypted files...');
                if (window.api?.getEncryptedFiles) {
                    const result = await window.api.getEncryptedFiles();
                    console.log('Encrypted files result:', result);
                    
                    if (result?.success && result.files) {
                        encryptedFiles = result.files;
                        console.log('Loaded encrypted files:', encryptedFiles);
                        updateEncryptedFilesList();
                        currentStats.encryptedFiles = encryptedFiles.length;
                        currentStats.totalFiles = encryptedFiles.length;
                        updateDashboard();
                    } else if (result?.files) {
                        // Handle case where success flag might not be set but files exist
                        encryptedFiles = result.files;
                        updateEncryptedFilesList();
                        currentStats.encryptedFiles = encryptedFiles.length;
                        currentStats.totalFiles = encryptedFiles.length;
                        updateDashboard();
                    } else {
                        console.log('No encrypted files found or API call failed');
                        encryptedFiles = [];
                        updateEncryptedFilesList();
                        currentStats.encryptedFiles = 0;
                        currentStats.totalFiles = 0;
                        updateDashboard();
                    }
                } else {
                    console.warn('getEncryptedFiles API not available');
                }
            } catch (error) {
                console.error('Error loading encrypted files:', error);
                encryptedFiles = [];
                updateEncryptedFilesList();
                currentStats.encryptedFiles = 0;
                currentStats.totalFiles = 0;
                updateDashboard();
            }
        }

        function updateEncryptedFilesList() {
            const encryptedFilesList = document.getElementById('encrypted-files-list');
            if (!encryptedFilesList) return;
            
            if (encryptedFiles.length === 0) {
                encryptedFilesList.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i class="fas fa-folder-open text-4xl mb-4"></i>
                        <p>No encrypted files found</p>
                        <p class="text-sm mt-2">Upload and encrypt files to see them here</p>
                    </div>
                `;
                return;
            }
            
            encryptedFilesList.innerHTML = encryptedFiles.map(file => {
                const securityLevel = getSecurityLevel(file.algorithm);
                const securityColor = securityLevel === 'High' ? 'text-green-400' : 
                                    securityLevel === 'Medium' ? 'text-yellow-400' : 'text-red-400';
                
                return `
                    <div class="bg-dark-light border border-slate-700 rounded-xl p-4 hover:border-slate-600 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-shield-alt text-green-400 text-lg"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-medium text-white mb-1">${file.name || file.originalName || 'Unknown File'}</h4>
                                    <div class="flex items-center space-x-4 text-sm text-slate-400">
                                        <span>${formatFileSize(file.size || file.originalSize || 0)}</span>
                                        <span class="text-green-400">●</span>
                                        <span>Encrypted</span>
                                        <span class="text-green-400">●</span>
                                        <span>${file.algorithm || 'AES-256-GCM'}</span>
                                        <span class="text-green-400">●</span>
                                        <span class="${securityColor}">${securityLevel} Security</span>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">
                                        Encrypted: ${formatDate(file.timestamp || file.dateEncrypted)}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="analyzeFile('${file.id}')" class="p-2 text-purple-400 hover:bg-purple-500/20 rounded-lg transition-colors" title="Analyze">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                                <button onclick="decryptFile('${file.id}', '${file.name || file.originalName}')" class="p-2 text-blue-400 hover:bg-blue-500/20 rounded-lg transition-colors" title="Decrypt">
                                    <i class="fas fa-unlock"></i>
                                </button>
                                <button onclick="downloadFile('${file.id}', '${file.name || file.originalName}')" class="p-2 text-green-400 hover:bg-green-500/20 rounded-lg transition-colors" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="deleteEncryptedFile('${file.id}')" class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getSecurityLevel(algorithm) {
            switch (algorithm) {
                case 'aes-256-gcm':
                    return 'High';
                case 'chacha20-poly1305':
                case 'xchacha20-poly1305':
                    return 'High';
                default:
                    return 'Medium';
            }
        }

        async function analyzeFile(fileId) {
            try {
                showProgressModal('Analyzing File', 'Performing cryptographic analysis...');
                
                if (window.api?.analyzeFileEntropy) {
                    const result = await window.api.analyzeFileEntropy(fileId);
                    hideProgressModal();
                    
                    if (result?.success) {
                        showAnalysisModal(result);
                    } else {
                        showToast('Failed to analyze file', 'error');
                    }
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error analyzing file:', error);
                showToast('Failed to analyze file', 'error');
            }
        }

        function showAnalysisModal(analysis) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-light border border-slate-700 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold">File Analysis Report</h3>
                        <button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-800 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-green-400">${analysis.overallEntropy?.toFixed(2) || 'N/A'}</div>
                                <div class="text-sm text-slate-400">Entropy Score</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold text-blue-400">${analysis.rating || 'Unknown'}</div>
                                <div class="text-sm text-slate-400">Security Rating</div>
                            </div>
                            <div class="bg-slate-800 rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold ${analysis.isGoodEncryption ? 'text-green-400' : 'text-yellow-400'}">
                                    ${analysis.isGoodEncryption ? 'Excellent' : 'Good'}
                                </div>
                                <div class="text-sm text-slate-400">Encryption Quality</div>
                            </div>
                        </div>
                        
                        ${analysis.histogram ? `
                            <div>
                                <h4 class="text-lg font-medium mb-3">Byte Distribution</h4>
                                <div class="bg-slate-800 rounded-lg p-4">
                                    <div class="text-sm text-slate-400 mb-2">Histogram shows randomness distribution (good encryption should be uniform)</div>
                                    <div class="h-32 flex items-end space-x-1">
                                        ${analysis.histogram.slice(0, 64).map((value, index) => `
                                            <div class="flex-1 bg-primary/60 rounded-t" style="height: ${(value / Math.max(...analysis.histogram)) * 100}%"></div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div>
                            <h4 class="text-lg font-medium mb-3">Analysis Details</h4>
                            <div class="bg-slate-800 rounded-lg p-4 space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">File Size:</span>
                                    <span>${formatFileSize(analysis.fileSize || 0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Entropy Range:</span>
                                    <span>0.00 - 8.00 bits</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Expected for Good Encryption:</span>
                                    <span class="text-green-400">> 7.5 bits</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Analysis Time:</span>
                                    <span>${new Date().toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function decryptFile(fileId, fileName) {
            try {
                showProgressModal('Decrypting', `Decrypting ${fileName}...`);
                
                if (window.api?.decryptFile) {
                    const result = await window.api.decryptFile(fileId);
                    hideProgressModal();
                    
                    if (result?.success) {
                        showToast(`Successfully decrypted ${fileName}`, 'success');
                    } else {
                        showToast(`Failed to decrypt ${fileName}`, 'error');
                    }
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error decrypting file:', error);
                showToast('Failed to decrypt file', 'error');
            }
        }

        async function downloadFile(fileId, fileName) {
            try {
                if (window.api?.downloadFile) {
                    const result = await window.api.downloadFile(fileId, fileName);
                    if (result?.success) {
                        showToast(`Downloaded ${fileName}`, 'success');
                    } else {
                        showToast(`Failed to download ${fileName}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error downloading file:', error);
                showToast('Failed to download file', 'error');
            }
        }

        async function deleteEncryptedFile(fileId) {
            if (confirm('Are you sure you want to delete this encrypted file?')) {
                try {
                    if (window.api?.deleteEncryptedFile) {
                        const result = await window.api.deleteEncryptedFile(fileId);
                        if (result?.success) {
                            showToast('File deleted successfully', 'success');
                            loadEncryptedFiles();
                        } else {
                            showToast('Failed to delete file', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Error deleting file:', error);
                    showToast('Failed to delete file', 'error');
                }
            }
        }

        async function loadSettings() {
            try {
                console.log('[Main] Loading settings...');
                if (window.settingsApi?.getAppSettings) {
                    const settings = await window.settingsApi.getAppSettings();
                    console.log('[Main] Received settings:', settings);
                    
                    if (settings) {
                        // Update output directory display
                        const outputDir = document.getElementById('output-dir');
                        if (outputDir) {
                            const outputPath = settings.outputDir || '';
                            outputDir.value = outputPath;
                            console.log('[Main] Updated output directory display to:', outputPath);
                        }
                        
                        // Update toggles
                        updateToggle('auto-delete', settings.autoDelete);
                        updateToggle('notifications', settings.notifications);
                        updateToggle('confirm-actions', settings.confirmActions);
                        updateToggle('auto-upload', settings.gdriveAutoUpload);
                        
                        console.log('[Main] Settings loaded successfully');
                    } else {
                        console.warn('[Main] No settings returned from API');
                    }
                } else {
                    console.warn('[Main] Settings API not available');
                }
            } catch (error) {
                console.error('[Main] Error loading settings:', error);
            }
        }

        function updateToggle(toggleId, checked) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.checked = checked;
                const event = new Event('change');
                toggle.dispatchEvent(event);
            }
        }

        async function saveSettings() {
            try {
                const settings = {
                    outputDir: document.getElementById('output-dir')?.value,
                    autoDelete: document.getElementById('auto-delete')?.checked,
                    notifications: document.getElementById('notifications')?.checked,
                    confirmActions: document.getElementById('confirm-actions')?.checked,
                    gdriveAutoUpload: document.getElementById('auto-upload')?.checked
                };
                
                if (window.settingsApi?.setAppSettings) {
                    await window.settingsApi.setAppSettings(settings);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
            }
        }

        async function selectOutputDirectory() {
            try {
                if (window.settingsApi?.selectOutputDirectory) {
                    const result = await window.settingsApi.selectOutputDirectory();
                    console.log('[Main] Select output directory result:', result);
                    
                    if (result && result !== null) {
                        // Update the display immediately
                        const outputDirField = document.getElementById('output-dir');
                        if (outputDirField) {
                            outputDirField.value = result;
                            console.log('[Main] Updated output-dir field to:', result);
                        }
                        
                        // Save the settings
                        await saveSettings();
                        showToast('Output directory updated successfully!', 'success');
                        
                        // Force refresh the settings to ensure UI is in sync
                        setTimeout(() => {
                            loadSettings();
                        }, 100);
                    } else {
                        console.log('[Main] Directory selection cancelled');
                        showToast('Directory selection cancelled', 'info');
                    }
                }
            } catch (error) {
                console.error('Error selecting output directory:', error);
                showToast('Failed to select output directory', 'error');
            }
        }

        async function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                try {
                    if (window.settingsApi?.resetAppSettings) {
                        await window.settingsApi.resetAppSettings();
                        loadSettings();
                        showToast('Settings reset to defaults', 'success');
                    }
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showToast('Failed to reset settings', 'error');
                }
            }
        }

        function updateDashboard() {
            // Update stats
            document.getElementById('total-files').textContent = currentStats.totalFiles;
            document.getElementById('encrypted-files').textContent = currentStats.encryptedFiles;
            document.getElementById('cloud-files').textContent = currentStats.cloudFiles;
            document.getElementById('security-level').textContent = currentStats.securityLevel;
            
            // Update security level color
            const securityElement = document.getElementById('security-level');
            if (securityElement) {
                securityElement.className = 'text-2xl font-bold ' + 
                    (currentStats.securityLevel === 'High' ? 'text-green-400' : 
                     currentStats.securityLevel === 'Medium' ? 'text-yellow-400' : 'text-red-400');
            }
        }

        function showProgressModal(title, text) {
            const modal = document.getElementById('progress-modal');
            const titleEl = document.getElementById('progress-title');
            const textEl = document.getElementById('progress-text');
            
            if (modal && titleEl && textEl) {
                titleEl.textContent = title;
                textEl.textContent = text;
                modal.classList.remove('hidden');
            }
        }

        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (progressText) progressText.textContent = text;
            if (progressPercentage) progressPercentage.textContent = Math.round(percentage) + '%';
        }

        function hideProgressModal() {
            const modal = document.getElementById('progress-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toast.className = `flex items-center space-x-3 ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <i class="${icons[type]}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Debug functions
        async function testFileDialog() {
            console.log('Testing file dialog...');
            try {
                const result = await window.api.openFileDialog();
                console.log('File dialog test result:', result);
                showToast(`File dialog returned: ${result?.length || 0} files`, 'info');
            } catch (error) {
                console.error('File dialog test error:', error);
                showToast('File dialog test failed', 'error');
            }
        }

        async function testKeyStatus() {
            console.log('Testing key status...');
            try {
                const status = await window.api.checkKeyStatus();
                console.log('Key status test result:', status);
                showToast(`Key status: ${status?.hasKey ? 'Active' : 'Not found'}`, 'info');
            } catch (error) {
                console.error('Key status test error:', error);
                showToast('Key status test failed', 'error');
            }
        }

        async function testEncryptedFiles() {
            console.log('Testing encrypted files loading...');
            try {
                const result = await window.api.getEncryptedFiles();
                console.log('Encrypted files test result:', result);
                showToast(`Found ${result?.files?.length || 0} encrypted files`, 'info');
            } catch (error) {
                console.error('Encrypted files test error:', error);
                showToast('Encrypted files test failed', 'error');
            }
        }

        // Key Management Functions
        let availableKeys = [];

        // Event delegation for export and delete buttons
        function setupKeyEventDelegation() {
            const keysList = document.getElementById('keys-list');
            if (keysList) {
                keysList.addEventListener('click', function(event) {
                    if (event.target.classList.contains('export-key-btn') || event.target.closest('.export-key-btn')) {
                        const btn = event.target.classList.contains('export-key-btn') ? event.target : event.target.closest('.export-key-btn');
                        const keyId = btn.dataset.keyId;
                        if (keyId) {
                            console.log('[Keys] Export button clicked for key:', keyId);
                            exportKey(keyId);
                        }
                    } else if (event.target.classList.contains('delete-key-btn') || event.target.closest('.delete-key-btn')) {
                        const btn = event.target.classList.contains('delete-key-btn') ? event.target : event.target.closest('.delete-key-btn');
                        const keyId = btn.dataset.keyId;
                        if (keyId) {
                            console.log('[Keys] Delete button clicked for key:', keyId);
                            deleteKey(keyId);
                        }
                    }
                });
            }
        }

        async function loadKeysList() {
            console.log('[Keys] Loading keys list...');
            try {
                if (window.api?.checkKeyStatus) {
                    console.log('[Keys] Calling checkKeyStatus API...');
                    const result = await window.api.checkKeyStatus();
                    console.log('[Keys] Key status result:', result);
                    
                    const keys = [];
                    
                    // Add current key if it exists
                    if (result && result.hasKey) {
                        console.log('[Keys] Key found, creating key object...');
                        
                        // Determine key type based on source or other indicators
                        let keyType = 'Generated Key';
                        let description = 'Currently active encryption key';
                        
                        if (result.source === 'filesystem') {
                            keyType = 'Stored Key';
                            description = 'Key loaded from filesystem';
                        } else if (result.source === 'keyManager.getMasterKey') {
                            keyType = 'Master Key';
                            description = 'Key from secure key manager';
                        }
                        
                        const keyObj = {
                            id: result.keyId || 'unknown',
                            type: keyType,
                            status: 'Active',
                            created: new Date().toLocaleDateString(),
                            isActive: true,
                            description: description,
                            source: result.source || 'memory'
                        };
                        
                        keys.push(keyObj);
                        console.log('[Keys] Created key object:', keyObj);
                    } else {
                        console.log('[Keys] No key found or hasKey is false');
                    }
                    
                    console.log('[Keys] Final keys array:', keys);
                    availableKeys = keys;
                    
                    console.log('[Keys] Calling displayKeysList with', keys.length, 'keys');
                    displayKeysList(keys);
                    
                    console.log('[Keys] Calling updateKeyStatus with hasKeys:', keys.length > 0);
                    updateKeyStatus(keys.length > 0);
                } else {
                    console.warn('[Keys] checkKeyStatus API not available');
                    displayKeysList([]);
                    updateKeyStatus(false);
                }
            } catch (error) {
                console.error('[Keys] Error loading keys:', error);
                displayKeysList([]);
                updateKeyStatus(false);
            }
        }

        function displayKeysList(keys) {
            console.log('[Keys] Displaying keys list:', keys);
            
            const keysList = document.getElementById('keys-list');
            const noKeysWarning = document.getElementById('no-keys-warning');
            
            console.log('[Keys] Found elements - keysList:', !!keysList, 'noKeysWarning:', !!noKeysWarning);
            
            if (!keysList || !noKeysWarning) {
                console.error('[Keys] Required elements not found - keysList:', !!keysList, 'noKeysWarning:', !!noKeysWarning);
                return;
            }
            
            if (keys.length === 0) {
                // No keys found
                console.log('[Keys] No keys to display, showing warning');
                keysList.style.display = 'none';
                noKeysWarning.style.display = 'block';
                return;
            }
            
            // Show keys list, hide warning
            console.log('[Keys] Showing keys list, hiding warning');
            keysList.style.display = 'block';
            noKeysWarning.style.display = 'none';
            
            // Force reflow to ensure display changes take effect
            keysList.offsetHeight;
            
            // Clear existing content completely
            while (keysList.firstChild) {
                keysList.removeChild(keysList.firstChild);
            }
            keysList.innerHTML = '';
            console.log('[Keys] Cleared existing list content');
            
            // Create key items
            console.log('[Keys] Creating', keys.length, 'key items');
            keys.forEach((key, index) => {
                console.log(`[Keys] Creating key item ${index + 1}:`, key);
                const keyItem = createKeyItem(key);
                keysList.appendChild(keyItem);
                console.log(`[Keys] Added key item ${index + 1} to list`);
            });
            
            // Force reflow after adding all items
            keysList.offsetHeight;
            
            console.log('[Keys] Finished displaying keys list, final DOM content:', keysList.innerHTML.length, 'characters');
        }

        function createKeyItem(key) {
            console.log('[Keys] Creating key item for:', key);
            const keyItem = document.createElement('div');
            keyItem.className = `bg-slate-800 border border-slate-600 rounded-lg p-4 hover:border-slate-500 transition-colors ${key.isActive ? 'ring-2 ring-green-500/50' : ''}`;
            keyItem.dataset.keyId = key.id;
            
            keyItem.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 ${key.isActive ? 'bg-green-500/20' : 'bg-slate-700'} rounded-lg flex items-center justify-center">
                            <i class="fas fa-key ${key.isActive ? 'text-green-400' : 'text-slate-400'} text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h4 class="font-medium text-white">${key.id}</h4>
                                <span class="px-2 py-1 text-xs ${key.isActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'} rounded-full">
                                    ${key.type}
                                </span>
                                ${key.isActive ? '<span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 rounded-full">Active</span>' : ''}
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-slate-400">
                                <span>Created: ${key.created}</span>
                                <span class="text-green-400">●</span>
                                <span>Status: ${key.status}</span>
                            </div>
                            ${key.description ? `<p class="text-xs text-slate-500 mt-1">${key.description}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${key.isActive ? `
                            <button class="export-key-btn px-3 py-1 text-sm bg-purple-500 hover:bg-purple-600 rounded-lg transition-colors" data-key-id="${key.id}">
                                <i class="fas fa-file-export mr-1"></i>
                                Export
                            </button>
                        ` : ''}
                        <button class="delete-key-btn px-3 py-1 text-sm bg-red-500 hover:bg-red-600 rounded-lg transition-colors" data-key-id="${key.id}">
                            <i class="fas fa-trash mr-1"></i>
                            Delete
                        </button>
                    </div>
                </div>
            `;
            
            return keyItem;
        }

        function updateKeyStatus(hasKeys) {
            const statusBanner = document.getElementById('current-key-status');
            const keyStatusSidebar = document.getElementById('key-status');
            
            if (statusBanner) {
                if (hasKeys) {
                    statusBanner.className = 'p-4 bg-green-500/10 border border-green-500/20 rounded-lg';
                    statusBanner.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-check-circle text-green-400"></i>
                            <div>
                                <p class="font-medium text-green-400">Encryption key is active</p>
                                <p class="text-sm text-slate-400">Your files can be encrypted securely</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusBanner.className = 'p-4 bg-red-500/10 border border-red-500/20 rounded-lg';
                    statusBanner.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                            <div>
                                <p class="font-medium text-red-400">No encryption key configured</p>
                                <p class="text-sm text-slate-400">Generate or import a key to start encrypting files</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Update sidebar status
            if (keyStatusSidebar) {
                if (hasKeys) {
                    keyStatusSidebar.className = 'flex items-center space-x-3 p-3 bg-green-500/20 border border-green-500/30 rounded-lg';
                    keyStatusSidebar.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <div>
                            <p class="text-sm font-medium text-green-400">Encryption Key Active</p>
                            <p class="text-xs text-slate-400">Ready to encrypt files</p>
                        </div>
                    `;
                } else {
                    keyStatusSidebar.className = 'flex items-center space-x-3 p-3 bg-red-500/20 border border-red-500/30 rounded-lg';
                    keyStatusSidebar.innerHTML = `
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <div>
                            <p class="text-sm font-medium">No Encryption Key</p>
                            <p class="text-xs text-slate-400">Generate or import a key</p>
                        </div>
                    `;
                }
            }

            // Update global state
            isKeyGenerated = hasKeys;
            currentStats.securityLevel = hasKeys ? 'High' : 'Low';
            updateDashboard();
        }

        async function generateNewKey() {
            try {
                showProgressModal('Generating Key', 'Creating a new secure encryption key...');
                
                if (window.api?.generateKey) {
                    const result = await window.api.generateKey();
                    hideProgressModal();
                    
                    if (result && result.success) {
                        showToast('New encryption key generated successfully!', 'success');
                        loadKeysList();
                    } else if (result && result.needsConfirmation) {
                        // Key already exists, ask for confirmation
                        const message = result.message || `A key (${result.existingKeyId}...) already exists. Creating a new key will replace it. This action cannot be undone.`;
                        
                        if (confirm(message + '\n\nDo you want to continue and replace the existing key?')) {
                            // User confirmed, force generate new key
                            try {
                                showProgressModal('Replacing Key', 'Replacing the existing encryption key...');
                                
                                if (window.api?.forceGenerateKey) {
                                    const forceResult = await window.api.forceGenerateKey();
                                    hideProgressModal();
                                    
                                    if (forceResult && forceResult.success) {
                                        showToast('Encryption key replaced successfully!', 'success');
                                        loadKeysList();
                                    } else {
                                        showToast('Failed to replace key: ' + (forceResult?.error || 'Unknown error'), 'error');
                                    }
                                } else {
                                    hideProgressModal();
                                    showToast('Force key generation not available', 'error');
                                }
                            } catch (forceError) {
                                hideProgressModal();
                                console.error('Error force generating key:', forceError);
                                showToast('Error replacing key: ' + forceError.message, 'error');
                            }
                        } else {
                            showToast('Key generation cancelled', 'info');
                        }
                    } else {
                        showToast('Failed to generate key: ' + (result?.error || 'Unknown error'), 'error');
                    }
                } else {
                    hideProgressModal();
                    showToast('Key generation not available', 'error');
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error generating key:', error);
                showToast('Error generating key: ' + error.message, 'error');
            }
        }

        async function createCustomKey() {
            const customKeyPanel = document.getElementById('custom-key-panel');
            if (customKeyPanel) {
                customKeyPanel.classList.toggle('hidden');
            }
        }

        async function createCustomKeyConfirm() {
            const passphraseInput = document.getElementById('custom-key-input');
            if (!passphraseInput) return;
            
            const passphrase = passphraseInput.value;
            if (!passphrase || passphrase.length < 8) {
                showToast('Enter a strong passphrase (at least 8 characters)', 'error');
                return;
            }
            
            // Check if there's an existing key and warn user
            if (availableKeys.length > 0) {
                const existingKey = availableKeys.find(k => k.isActive);
                if (existingKey) {
                    const confirmMessage = `A key (${existingKey.id}) already exists. Creating a custom key will replace it. This action cannot be undone.\n\nDo you want to continue?`;
                    if (!confirm(confirmMessage)) {
                        showToast('Custom key creation cancelled', 'info');
                        return;
                    }
                }
            }
            
            try {
                showProgressModal('Creating Custom Key', 'Deriving key from your passphrase...');
                
                if (window.api?.createCustomKey) {
                    const result = await window.api.createCustomKey(passphrase, passphrase);
                    hideProgressModal();
                    
                    if (result && result.success) {
                        showToast('Custom key created successfully!', 'success');
                        passphraseInput.value = '';
                        document.getElementById('custom-key-panel').classList.add('hidden');
                        loadKeysList();
                    } else {
                        showToast('Failed to create custom key: ' + (result?.error || 'Unknown error'), 'error');
                    }
                } else {
                    hideProgressModal();
                    showToast('Custom key creation not available', 'error');
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error creating custom key:', error);
                showToast('Error creating custom key: ' + error.message, 'error');
            }
        }

        function cancelCustomKey() {
            const customKeyPanel = document.getElementById('custom-key-panel');
            const passphraseInput = document.getElementById('custom-key-input');
            
            if (customKeyPanel) customKeyPanel.classList.add('hidden');
            if (passphraseInput) passphraseInput.value = '';
        }

        async function importKey() {
            try {
                if (window.api?.importKey) {
                    // Check if there's an existing key and warn user
                    if (availableKeys.length > 0) {
                        const existingKey = availableKeys.find(k => k.isActive);
                        if (existingKey) {
                            const confirmMessage = `A key (${existingKey.id}) already exists. Importing a new key will replace it. This action cannot be undone.\n\nDo you want to continue?`;
                            if (!confirm(confirmMessage)) {
                                showToast('Key import cancelled', 'info');
                                return;
                            }
                        }
                    }
                    
                    // For now, show a simple prompt - this could be enhanced with a proper file picker
                    const keyData = prompt('Enter your encryption key (64 hex characters):');
                    if (!keyData) return;
                    
                    const cleanedKey = keyData.replace(/\s+/g, '');
                    if (!/^[0-9a-fA-F]{64}$/.test(cleanedKey)) {
                        showToast('Invalid key format. Must be 64 hex characters (0-9, A-F).', 'error');
                        return;
                    }
                    
                    showProgressModal('Importing Key', 'Loading your encryption key...');
                    
                    const result = await window.api.importKey(cleanedKey);
                    hideProgressModal();
                    
                    if (result && result.success) {
                        showToast('Key imported successfully!', 'success');
                        loadKeysList();
                    } else {
                        showToast('Failed to import key: ' + (result?.error || 'Unknown error'), 'error');
                    }
                } else {
                    showToast('Key import not available', 'error');
                }
            } catch (error) {
                hideProgressModal();
                console.error('Error importing key:', error);
                showToast('Error importing key: ' + error.message, 'error');
            }
        }

        async function exportKey(keyId) {
            console.log('[Keys] Exporting key with ID:', keyId);
            try {
                if (window.api?.exportKey) {
                    showProgressModal('Exporting Key', 'Preparing key file for export...');
                    const result = await window.api.exportKey(keyId);
                    hideProgressModal();
                    
                    if (result && result.success) {
                        showToast(`Key exported successfully to: ${result.exportPath || result.filePath || 'Downloads'}`, 'success');
                        console.log('[Keys] Key exported to:', result.exportPath || result.filePath);
                    } else {
                        showToast('Failed to export key: ' + (result?.error || 'Unknown error'), 'error');
                        console.error('[Keys] Export failed:', result.error);
                    }
                } else {
                    showToast('Key export not available', 'error');
                    console.error('[Keys] Export API not available');
                }
            } catch (error) {
                hideProgressModal();
                console.error('[Keys] Export error:', error);
                showToast('Error exporting key: ' + error.message, 'error');
            }
        }

        async function deleteKey(keyId) {
            console.log('[Keys] Deleting key with ID:', keyId);
            
            const confirmMessage = `Are you sure you want to delete the encryption key "${keyId}"?\n\nThis action cannot be undone. Any files encrypted with this key will become inaccessible unless you have a backup of the key.`;
            if (!confirm(confirmMessage)) {
                console.log('[Keys] Key deletion cancelled by user');
                return;
            }
            
            try {
                if (window.api?.deleteKey) {
                    showProgressModal('Deleting Key', 'Removing encryption key...');
                    const result = await window.api.deleteKey(keyId);
                    hideProgressModal();
                    
                    if (result && result.success) {
                        showToast('Encryption key deleted successfully!', 'success');
                        console.log('[Keys] Key deleted successfully');
                        
                        // Refresh the keys list to show the updated state
                        await loadKeysList();
                    } else {
                        showToast('Failed to delete key: ' + (result?.error || 'Unknown error'), 'error');
                        console.error('[Keys] Delete failed:', result.error);
                    }
                } else {
                    showToast('Key deletion not available', 'error');
                    console.error('[Keys] Delete API not available');
                }
            } catch (error) {
                hideProgressModal();
                console.error('[Keys] Delete error:', error);
                showToast('Error deleting key: ' + error.message, 'error');
            }
        }

        async function refreshKeysList() {
            const refreshBtn = document.getElementById('refresh-keys-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spin fa-sync-alt mr-2"></i>Refreshing...';
            }
            
            await loadKeysList();
            showToast('Keys list refreshed!', 'info');
            
            if (refreshBtn) {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh List';
                }, 1000);
            }
        }

        // Setup custom key entropy meter
        function setupCustomKeyEntropy() {
            const customKeyInput = document.getElementById('custom-key-input');
            const createBtn = document.getElementById('create-custom-key-confirm');
            const entropyFill = document.getElementById('entropy-fill');
            const entropyStatus = document.getElementById('entropy-status');
            
            if (customKeyInput) {
                customKeyInput.addEventListener('input', function() {
                    const passphrase = customKeyInput.value;
                    const entropy = calculateEntropy(passphrase);
                    
                    if (entropyFill && entropyStatus) {
                        updateEntropyMeter(entropy, entropyFill, entropyStatus);
                    }
                    
                    if (createBtn) {
                        createBtn.disabled = entropy < 60 || passphrase.length < 8;
                    }
                });
            }
        }

        function calculateEntropy(password) {
            if (!password || password.length === 0) return 0;
            
            const length = password.length;
            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasDigit = /\d/.test(password);
            const hasSpecial = /[^a-zA-Z0-9]/.test(password);
            
            let charSetSize = 0;
            if (hasLower) charSetSize += 26;
            if (hasUpper) charSetSize += 26;
            if (hasDigit) charSetSize += 10;
            if (hasSpecial) charSetSize += 33;
            
            if (charSetSize === 0) charSetSize = 95;
            
            const entropy = length * Math.log2(charSetSize);
            return Math.round(entropy);
        }

        function updateEntropyMeter(entropyBits, entropyFill, entropyStatus) {
            let percentage = Math.min(100, (entropyBits / 128) * 100);
            entropyFill.style.width = `${percentage}%`;
            
            let color, strength;
            if (entropyBits < 40) {
                color = 'bg-red-500';
                strength = 'Very Weak';
            } else if (entropyBits < 60) {
                color = 'bg-orange-500';
                strength = 'Weak';
            } else if (entropyBits < 80) {
                color = 'bg-yellow-500';
                strength = 'Moderate';
            } else if (entropyBits < 100) {
                color = 'bg-green-500';
                strength = 'Strong';
            } else {
                color = 'bg-green-600';
                strength = 'Very Strong';
            }
            
            entropyFill.className = `${color} h-2 rounded-full transition-all duration-300`;
            entropyStatus.textContent = `Strength: ${strength} (${entropyBits} bits)`;
        }

        // Global functions for onclick handlers
        window.removeFromQueue = removeFromQueue;
        window.downloadFromDrive = downloadFromDrive;
        window.decryptFile = decryptFile;
        window.downloadFile = downloadFile;
        window.deleteEncryptedFile = deleteEncryptedFile;
        window.analyzeFile = analyzeFile;
        window.showAnalysisModal = showAnalysisModal;
        window.testFileDialog = testFileDialog;
        window.testKeyStatus = testKeyStatus;
        window.testEncryptedFiles = testEncryptedFiles;
        window.exportKey = exportKey;
        window.deleteKey = deleteKey;
    </script>
</body>
</html>